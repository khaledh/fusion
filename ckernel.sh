#!/bin/bash

set -x

git restore ovmf/OVMF_VARS.fd

# nim c --noLinking:on src/kernel/main.nim
clang -c -w -ferror-limit=3 -masm=intel -nostdlibinc -Isrc/include -target x86_64-unknown-none -ffreestanding -ffunction-sections -mcmodel=large -mno-red-zone   -I/usr/lib64/nim/lib -I/home/khaled/src/fusion/src/kernel -o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@ssystem.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@ssystem.nim.c
clang -c -w -ferror-limit=3 -masm=intel -nostdlibinc -Isrc/include -target x86_64-unknown-none -ffreestanding -ffunction-sections -mcmodel=large -mno-red-zone   -I/usr/lib64/nim/lib -I/home/khaled/src/fusion/src/kernel -o /home/khaled/src/fusion/build/kernel/@mgdt.nim.c.o /home/khaled/src/fusion/build/kernel/@mgdt.nim.c
clang -c -w -ferror-limit=3 -masm=intel -nostdlibinc -Isrc/include -target x86_64-unknown-none -ffreestanding -mgeneral-regs-only -ffunction-sections -mcmodel=large -mno-red-zone   -I/usr/lib64/nim/lib -I/home/khaled/src/fusion/src/kernel -o /home/khaled/src/fusion/build/kernel/@mmain.nim.c.o /home/khaled/src/fusion/build/kernel/@mmain.nim.c

ld.lld   -o /home/khaled/src/fusion/build/kernel/kernel.bin  /home/khaled/src/fusion/build/kernel/@m..@sinclude@sstdio.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@ssystem@sexceptions.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@sstd@sprivate@sdigitsutils.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@sstd@sassertions.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@ssystem@sdollars.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@sstd@swidestrs.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@ssystem.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@spure@soptions.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@spure@sparseutils.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@spure@sunicode.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@spure@smath.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@spure@salgorithm.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@spure@sstrutils.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@spure@sstrformat.nim.c.o /home/khaled/src/fusion/build/kernel/@mports.nim.c.o /home/khaled/src/fusion/build/kernel/@mdebugcon.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@scommon@suefi.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@scommon@slibc.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@scommon@smalloc.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@scommon@spagetables.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@spure@shashes.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@spure@scollections@stables.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@s..@s..@s..@s..@s..@susr@slib64@snim@slib@spure@scollections@sdeques.nim.c.o /home/khaled/src/fusion/build/kernel/@m..@snimpatches@sheapqueue.nim.c.o /home/khaled/src/fusion/build/kernel/@mcpu.nim.c.o /home/khaled/src/fusion/build/kernel/@mgdt.nim.c.o /home/khaled/src/fusion/build/kernel/@mpmm.nim.c.o /home/khaled/src/fusion/build/kernel/@mvmm.nim.c.o /home/khaled/src/fusion/build/kernel/@mtaskdef.nim.c.o /home/khaled/src/fusion/build/kernel/@mctxswitch.nim.c.o /home/khaled/src/fusion/build/kernel/@msched.nim.c.o /home/khaled/src/fusion/build/kernel/@mpit.nim.c.o /home/khaled/src/fusion/build/kernel/@mlapic.nim.c.o /home/khaled/src/fusion/build/kernel/@mloader.nim.c.o /home/khaled/src/fusion/build/kernel/@midt.nim.c.o /home/khaled/src/fusion/build/kernel/@mtimer.nim.c.o /home/khaled/src/fusion/build/kernel/@mtaskmgr.nim.c.o /home/khaled/src/fusion/build/kernel/@mlocks.nim.c.o /home/khaled/src/fusion/build/kernel/@mcondvars.nim.c.o /home/khaled/src/fusion/build/kernel/@mqueues.nim.c.o /home/khaled/src/fusion/build/kernel/@mchannels.nim.c.o /home/khaled/src/fusion/build/kernel/@mdrivers@spci.nim.c.o /home/khaled/src/fusion/build/kernel/@mdrivers@sbga.nim.c.o /home/khaled/src/fusion/build/kernel/@mdevmgr.nim.c.o /home/khaled/src/fusion/build/kernel/@mgfxsrv.nim.c.o /home/khaled/src/fusion/build/kernel/@msyscalls.nim.c.o /home/khaled/src/fusion/build/kernel/@mmain.nim.c.o   --nostdlib --entry=KernelMain --script=src/kernel/kernel.ld --Map=build/kernel/kernel.map --oformat=binary

cp build/kernel/kernel.bin diskimg/efi/fusion/kernel.bin

qemu-system-x86_64 -drive if=pflash,format=raw,file=ovmf/OVMF_CODE.fd,readonly=on -drive if=pflash,format=raw,file=ovmf/OVMF_VARS.fd -drive format=raw,file=fat:rw:diskimg -machine q35 -net none -no-reboot -debugcon stdio
